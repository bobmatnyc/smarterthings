# Configuration Menu Guide

Interactive configuration tool for managing SmartThings MCP Server credentials and settings.

---

## Quick Start

**Development Mode** (recommended):
```bash
pnpm config:dev
```

**Production Mode**:
```bash
pnpm config
```

---

## Menu Options

### 1ï¸âƒ£ Configure SmartThings PAT

Set up your SmartThings Personal Access Token.

**What you'll need:**
- SmartThings account
- Personal Access Token with appropriate scopes

**Steps:**
1. Visit: https://account.smartthings.com/tokens
2. Click "Generate new token"
3. Name it (e.g., "MCP Server")
4. Select scopes:
   - âœ… `l:devices` (read devices)
   - âœ… `x:devices:*` (control devices)
   - âœ… `l:locations` (read locations)
   - âœ… `r:scenes:*` (read/execute scenes)
5. Copy the token (you won't see it again!)
6. Paste into the config menu

**Token Validation:**
The menu automatically tests your token by:
- Connecting to SmartThings API
- Listing your locations
- Verifying permissions

**Success Output:**
```
âœ… Token is valid!
   Found 1 location(s)
   Locations:
   - My Home
```

---

### 2ï¸âƒ£ Configure OpenRouter API Key

Set up your OpenRouter API key for LLM interactions.

**What you'll need:**
- OpenRouter account
- API key

**Steps:**
1. Visit: https://openrouter.ai/keys
2. Sign in or create account
3. Click "Create Key"
4. Copy the API key
5. Paste into the config menu

**Note:** The chat interface uses OpenRouter to process natural language commands.

---

### 3ï¸âƒ£ Test SmartThings Connection

Verify your SmartThings token is working.

**What it tests:**
- API connectivity
- Token validity
- Permission scopes
- Available locations

**Example Output:**
```
ðŸ” Testing SmartThings Connection
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Testing connection...
âœ… Token is valid!
   Found 1 location(s)
   Locations:
   - My Home
```

**Common Errors:**

âŒ **Token is invalid or expired**
- Solution: Generate a new PAT token
- Tokens expire based on your SmartThings account settings

âŒ **Network error**
- Solution: Check internet connection
- Verify SmartThings API is accessible

âŒ **Permission denied**
- Solution: Regenerate token with correct scopes
- Required scopes: devices, locations, scenes

---

### 4ï¸âƒ£ View Current Configuration

Display current configuration status with masked credentials.

**Example Output:**
```
ðŸ“‹ Current Configuration:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SmartThings PAT:      c9a1...e4f2
OpenRouter API Key:   sk-o...h8k3
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**Security:**
- Only first 4 and last 4 characters shown
- Full credentials never displayed in terminal
- Stored securely in `.env.local`

---

### 5ï¸âƒ£ Clear All Configuration

Remove all stored credentials from `.env.local`.

**Warning:** This action:
- âŒ Deletes all stored tokens
- âŒ Removes all API keys
- âŒ Clears entire `.env.local` file

**Use case:**
- Troubleshooting configuration issues
- Switching SmartThings accounts
- Security purposes (remove old tokens)

**Confirmation Required:**
```
âš ï¸  Clear All Configuration
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Are you sure? This will delete all stored credentials. (y/N):
```

---

## Configuration Storage

**File Location:**
```
/Users/masa/Projects/mcp-smartthings/.env.local
```

**File Format:**
```bash
# mcp-smarterthings configuration
# Generated by config menu

SMARTTHINGS_PAT=your-token-here
SMARTTHINGS_TOKEN=your-token-here
OPENROUTER_API_KEY=your-key-here
```

**Security:**
- `.env.local` is in `.gitignore`
- Never committed to version control
- File permissions: 644 (readable by owner)

---

## Troubleshooting

### Config Menu Won't Start

**Error:** `Cannot find module 'dist/cli/config.js'`

**Solution:**
```bash
pnpm tsc  # Build the project first
pnpm config
```

Or use development mode:
```bash
pnpm config:dev  # No build required
```

---

### Token Test Fails But Token is Valid

**Symptoms:**
- Token works in SmartThings app
- Config menu shows "Token is invalid"

**Common Causes:**
1. **Network issues:** Check internet connection
2. **Rate limiting:** Wait a few minutes and try again
3. **Token format:** Ensure no extra spaces when pasting
4. **Expired token:** Generate a new PAT

**Solution:**
```bash
# Test manually with curl
curl -H "Authorization: Bearer YOUR_TOKEN" \
     https://api.smartthings.com/v1/locations
```

If curl works but config menu doesn't, file an issue.

---

### Configuration Not Persisting

**Symptoms:**
- Settings save successfully
- Chat interface still shows "PAT not configured"

**Solution:**
1. Verify `.env.local` exists:
   ```bash
   ls -la .env.local
   ```

2. Check file contents (masked):
   ```bash
   cat .env.local | sed 's/=.*/=***/'
   ```

3. Restart terminal or reload environment:
   ```bash
   source .env.local  # If using bash/zsh
   ```

---

### Multiple Tokens for Different Homes

**Current Limitation:**
The config menu only supports one SmartThings token at a time.

**Workaround:**
1. Use config menu to switch tokens as needed
2. Or manually edit `.env.local` to swap tokens

**Future Enhancement:**
Multi-home support with profile switching planned for future release.

---

## Next Steps

After configuration:

1. **Test the chat interface:**
   ```bash
   pnpm chat:dev
   ```

2. **Try basic commands:**
   ```
   You: List all my devices
   You: Show me devices in the living room
   ```

3. **Read the chat guide:**
   ```bash
   cat docs/CHAT_INTERFACE_GUIDE.md
   ```

---

## Advanced Usage

### Non-Interactive Configuration

For automation or CI/CD:

```bash
# Create .env.local manually
cat > .env.local << EOF
SMARTTHINGS_PAT=your-pat-token
OPENROUTER_API_KEY=your-openrouter-key
EOF

# Verify configuration
pnpm config:dev
# Select option 3 (Test Connection)
# Select option 0 (Exit)
```

### Environment Variable Priority

Configuration loading order:
1. `.env.local` (highest priority)
2. Environment variables
3. `.env` (lowest priority)

### Backup Configuration

```bash
# Backup current config
cp .env.local .env.local.backup

# Restore from backup
cp .env.local.backup .env.local
```

---

## Security Best Practices

1. **Never commit `.env.local`**
   - Already in `.gitignore`
   - Double-check before commits

2. **Rotate tokens regularly**
   - Generate new PAT every 3-6 months
   - Use config menu to update easily

3. **Use minimal scopes**
   - Only grant necessary permissions
   - Review token scopes periodically

4. **Protect your tokens**
   - Don't share screenshots with visible tokens
   - Don't paste tokens in public channels
   - Use token masking in logs

---

## FAQ

**Q: Do I need both SMARTTHINGS_PAT and SMARTTHINGS_TOKEN?**

A: They're the same value. The config menu sets both for compatibility with different code paths. Future versions will consolidate to one variable.

**Q: Can I use multiple OpenRouter API keys?**

A: Currently, only one API key is supported. The chat interface uses this key for all LLM requests.

**Q: What if I lose my SmartThings PAT?**

A: Generate a new one at https://account.smartthings.com/tokens. Old tokens are automatically invalidated when you delete them.

**Q: Is my token secure?**

A: Yes, as long as:
- You don't commit `.env.local` to git
- You use proper file permissions
- You don't share the file

**Q: Can I edit `.env.local` manually?**

A: Yes! The config menu is a convenience tool. You can always edit `.env.local` directly if you prefer.

---

## Support

**Issues or Questions:**
- GitHub Issues: https://github.com/bobmatnyc/mcp-smarterthings/issues
- Check existing issues before creating new ones
- Include error messages and steps to reproduce

**Configuration Help:**
- SmartThings PAT: https://account.smartthings.com/tokens
- OpenRouter API: https://openrouter.ai/docs

---

**Last Updated:** 2025-11-26
**Version:** 0.6.1
