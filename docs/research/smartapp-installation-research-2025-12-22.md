# SmartApp Installation and InstalledAppId Research

**Date**: 2025-12-22
**Research Type**: SmartApp Installation and Event Subscription Setup
**Status**: Complete
**Ticket**: N/A (Ad-hoc research)

---

## Executive Summary

SmartApp installation **cannot be automated programmatically**. The `installedAppId` is generated by SmartThings cloud when a user installs the SmartApp via the SmartThings mobile app. However, the codebase already has infrastructure to handle the installation lifecycle once the user completes this process.

**Key Finding**: The webhook handler is **missing INSTALL and CONFIGURATION lifecycle handlers**, which are required to:
1. Receive the `installedAppId` from SmartThings during installation
2. Automatically create subscriptions for device events
3. Store installation context for future event processing

---

## Current State Analysis

### ✅ What's Already Working

1. **SmartApp Registration**:
   - SmartApp registered with SmartThings: `appId: 282fe848-d5c0-4ab5-8240-2cbb732005f9`
   - Webhook URL configured: `https://smarty.ngrok.app/webhook/smartthings`
   - OAuth2 flow implemented and working

2. **Webhook Infrastructure**:
   - HMAC signature verification implemented
   - Fast acknowledgment (<100ms) architecture
   - Event processing pipeline (queue → store → SSE broadcast)
   - Support for PING, CONFIRMATION, EVENT, and UNINSTALL lifecycles

3. **Subscription Service**:
   - `SubscriptionService` class exists in `src/smartthings/subscription-service.ts`
   - Methods for creating capability-based subscriptions
   - Default subscription configurations for key capabilities (motion, contact, switch, etc.)
   - Subscription CRUD operations implemented

4. **InstalledApp Listing**:
   - `listInstalledApps()` method exists in SmartThings client
   - Server initialization attempts to fetch installedAppId on startup
   - Code in `server-alexa.ts:initializeSubscriptionContext()` fetches first installed app

### ❌ What's Missing

1. **No INSTALL Lifecycle Handler**:
   - Webhook only handles: `PING`, `CONFIRMATION`, `EVENT`, `UNINSTALL`
   - Missing: `INSTALL` lifecycle event handler
   - Impact: Cannot automatically receive installedAppId during installation

2. **No CONFIGURATION Lifecycle Handler**:
   - Missing configuration flow for user-guided setup
   - Cannot define configuration pages or receive user inputs
   - Impact: Installation process cannot be customized

3. **No Automatic Subscription Creation**:
   - Manual subscription setup required after installation
   - No automation to create subscriptions on install
   - Impact: Events will not flow until subscriptions manually created

4. **No Persistent Storage of InstalledAppId**:
   - Current code fetches installedAppId on server startup
   - No persistent storage across server restarts
   - Fragile: Depends on installedApp existing at startup time

---

## How SmartApp Installation Works

### Installation Flow (User-Initiated)

```
User Action (Mobile App)          SmartThings Cloud              Your Server
─────────────────────────         ─────────────────              ────────────

1. User opens SmartThings app
   → SmartApps section
   → "+ Add SmartApp"

2. User finds your app            → Generate installedAppId
   → Clicks "Install"              → (UUID format)

3. Configuration screens          POST /webhook/smartthings     ← CONFIGURATION
   (if implemented)                ├─ lifecycle: CONFIGURATION
                                   └─ configurationData:
                                      └─ installedAppId: "uuid"

4. User grants permissions                                      → Return config
                                                                  pages (if any)

5. User confirms installation     POST /webhook/smartthings     ← INSTALL
                                   ├─ lifecycle: INSTALL
                                   ├─ installData:
                                   │  └─ installedApp:
                                   │     ├─ installedAppId: "uuid"
                                   │     ├─ locationId: "loc-id"
                                   │     └─ config: {...}
                                   └─ authToken: "24hr-token"

                                                                → Store context
                                                                → Create subs
                                                                → Return 200 OK

6. Installation complete!         ← SmartApp is now installed
                                   ← subscriptions active
```

### Lifecycle Events Sequence

1. **CONFIGURATION** (Optional):
   - SmartThings sends: `configurationData.installedAppId`
   - Purpose: Allow user to configure the app during installation
   - Response: Define configuration pages (devices to authorize, settings, etc.)

2. **INSTALL** (Required):
   - SmartThings sends: `installData.installedApp.installedAppId`
   - **Critical**: This is when you should create subscriptions
   - Response: Acknowledge installation (200 OK)

3. **UPDATE** (Optional):
   - User changes app configuration
   - Similar to INSTALL, but for updates

4. **UNINSTALL** (Already handled):
   - User uninstalls the app
   - Clean up subscriptions and resources

---

## Why Programmatic Installation Isn't Possible

### SmartThings Architecture Constraints

1. **User-Centric Security Model**:
   - SmartApps require explicit user consent via mobile app
   - User must grant device permissions manually
   - Cannot be bypassed programmatically (security by design)

2. **Token Scoping**:
   - Personal Access Tokens (PAT) cannot access `/installedapps` endpoints
   - Only SmartApp-issued tokens (from INSTALL event) have necessary scopes
   - PAT is for user-level API access, not SmartApp management

3. **Installation is User Action**:
   - Installation creates an "instance" of your app for that user
   - Each user gets unique `installedAppId`
   - One app registration → many installed instances

### What You CAN Do Programmatically

1. **List Installed Apps** (after user installs):
   ```typescript
   const installedApps = await client.installedApps.list({
     locationId: 'location-uuid',
     installedAppStatus: 'AUTHORIZED'
   });
   ```

2. **Create Subscriptions** (after receiving installedAppId):
   ```typescript
   await client.subscriptions.create({
     sourceType: 'CAPABILITY',
     capability: {
       locationId: 'loc-id',
       capability: 'motionSensor',
       attribute: 'motion',
       subscriptionName: 'motion-events'
     }
   }, installedAppId);
   ```

3. **Delete Subscriptions**:
   ```typescript
   await client.subscriptions.delete(installedAppId, subscriptionId);
   ```

---

## Required Implementation

### 1. Add INSTALL Lifecycle Handler

**Location**: `src/routes/webhook.ts`

**Update Required**:
```typescript
const SmartThingsLifecycle = z.enum([
  'PING',
  'CONFIRMATION',
  'EVENT',
  'UNINSTALL',
  'INSTALL',      // ADD THIS
  'CONFIGURATION' // ADD THIS (optional but recommended)
]);
```

**Add Install Handler**:
```typescript
case 'INSTALL': {
  const installData = webhookData.installData;
  if (!installData) {
    logger.error('[Webhook] INSTALL lifecycle missing installData');
    return reply.code(400).send({ error: 'Missing installData' });
  }

  const { installedAppId, locationId } = installData.installedApp;

  logger.info('[Webhook] INSTALL received', {
    installedAppId,
    locationId
  });

  // Store installedAppId persistently
  // TODO: Add persistent storage (database or file)

  // Initialize subscription service
  const subService = getSubscriptionService();
  subService.setContext(installedAppId, locationId);

  // Create default subscriptions
  try {
    const results = await subService.subscribeToDefaults();
    logger.info('[Webhook] Subscriptions created', results);
  } catch (error) {
    logger.error('[Webhook] Failed to create subscriptions', { error });
  }

  return reply.code(200).send({ statusCode: 200 });
}
```

### 2. Add Persistent Storage for InstalledAppId

**Options**:
1. **File-based** (simplest for single user):
   - Store in `.smartthings/installation.json`
   - Load on server startup

2. **Database** (multi-user):
   - Store in SQLite/PostgreSQL
   - Support multiple installations per location

3. **Environment variable** (temporary):
   - Least robust, but quickest to test
   - `SMARTTHINGS_INSTALLED_APP_ID=uuid`

**Recommendation**: Start with file-based storage, migrate to database if multi-user support needed.

### 3. Add CONFIGURATION Lifecycle Handler (Optional)

**Purpose**:
- Define configuration pages for user during installation
- Request device permissions
- Collect settings (refresh interval, notification preferences, etc.)

**Implementation**: See SmartThings SDK examples for configuration page definitions.

---

## Alternative: Manual Installation Process

If you want to get events working **immediately** without implementing lifecycle handlers:

### Step 1: User Installs via Mobile App

1. Open SmartThings mobile app
2. Go to "Automations" → "SmartApps"
3. Find your registered SmartApp (if published)
4. Complete installation flow
5. Grant device permissions

### Step 2: Retrieve InstalledAppId

**Via API** (after user installs):
```bash
# List installed apps for location
curl -X GET "https://api.smartthings.com/v1/installedapps?locationId=YOUR_LOCATION_ID" \
  -H "Authorization: Bearer YOUR_PAT"
```

**Via Code** (already exists):
```typescript
import { smartThingsService } from './smartthings/client.js';

const locations = await smartThingsService.listLocations();
const locationId = locations[0].locationId;

const installedApps = await smartThingsService.listInstalledApps(locationId);
const installedAppId = installedApps[0].id;

console.log('InstalledAppId:', installedAppId);
```

### Step 3: Create Subscriptions Manually

**Via MCP Tool** (if exposed):
```typescript
// Pseudo-code for MCP tool call
await createSubscription({
  installedAppId: 'uuid-from-step-2',
  locationId: 'location-uuid',
  capability: 'motionSensor'
});
```

**Via Standalone Script**:
```bash
node scripts/create-subscriptions.js
```

---

## Recommended Next Steps

### Immediate (Get Events Working Now)

1. **Manual Installation**:
   - User installs SmartApp via mobile app
   - Retrieve installedAppId via existing `listInstalledApps()` code
   - Store installedAppId in environment variable or config file

2. **Create Subscriptions**:
   - Use existing `SubscriptionService.subscribeToDefaults()`
   - Run once to create all necessary subscriptions

3. **Test Event Flow**:
   - Trigger motion sensor event
   - Verify webhook receives EVENT lifecycle
   - Confirm SSE broadcast to frontend

### Short-term (Production Ready)

1. **Implement INSTALL Lifecycle Handler**:
   - Add case to webhook switch statement
   - Extract installedAppId from installData
   - Automatically create subscriptions on install

2. **Add Persistent Storage**:
   - File-based: `.smartthings/installation.json`
   - Load on server startup
   - Update on INSTALL/UNINSTALL events

3. **Error Handling**:
   - Handle missing installedAppId gracefully
   - Retry subscription creation on failure
   - Log installation events for debugging

### Long-term (Multi-User Support)

1. **Database Storage**:
   - Store multiple installations per user
   - Track subscription state per installation
   - Support user-specific device selections

2. **Configuration UI**:
   - Implement CONFIGURATION lifecycle
   - Allow users to select devices to monitor
   - Customize notification settings

3. **Admin Dashboard**:
   - View all installations
   - Manage subscriptions
   - Debug webhook events

---

## Code References

### Existing Infrastructure

- **Webhook Handler**: `src/routes/webhook.ts`
  - Lifecycle handling: Lines 210-341
  - Missing: INSTALL and CONFIGURATION cases

- **Subscription Service**: `src/smartthings/subscription-service.ts`
  - `setContext()`: Line 43
  - `subscribeToDefaults()`: Line 108
  - Default subscriptions: Lines 18-29

- **SmartThings Client**: `src/smartthings/client.ts`
  - `listInstalledApps()`: Line 1001

- **Server Initialization**: `src/server-alexa.ts`
  - `initializeSubscriptionContext()`: Line 1787
  - Fetches first installedApp on startup

### SmartThings SDK Methods

```typescript
// List installed apps
await client.installedApps.list({
  locationId: string,
  installedAppStatus: 'AUTHORIZED'
});

// Create subscription
await client.subscriptions.create({
  sourceType: 'CAPABILITY',
  capability: {
    locationId: string,
    capability: string,
    attribute: string,
    subscriptionName: string
  }
}, installedAppId);

// List subscriptions
await client.subscriptions.list(installedAppId);

// Delete subscription
await client.subscriptions.delete(installedAppId, subscriptionId);
```

---

## Documentation References

### SmartThings Official Docs

- **Lifecycles**: [SmartThings Lifecycles Guide](https://developer.smartthings.com/docs/connected-services/lifecycles)
  - INSTALL phase explanation
  - installedAppId delivery mechanism
  - Subscription creation best practices

- **SmartApp Basics**: [SmartApp Basics](https://developer.smartthings.com/docs/connected-services/smartapp-basics)
  - User-centric installation flow
  - Token scoping and permissions

- **Configuration**: [Configuration Guide](https://developer.smartthings.com/docs/connected-services/configuration)
  - Configuration lifecycle details
  - Dynamic page generation

### Community Discussions

- [How can I receive installedAppId?](https://community.smartthings.com/t/how-can-i-receive-installedappid/222908)
  - User asks about programmatic installation
  - Community confirms: Must be user-initiated

- [Why do we need InstalledappId?](https://community.smartthings.com/t/why-do-we-need-installedappid/110289)
  - Explains installedAppId purpose
  - One app → many installations

---

## Conclusion

**There is no way to programmatically install a SmartApp and obtain an installedAppId via API calls.** Installation is a user-initiated process through the SmartThings mobile app, by design.

However, once the user installs the SmartApp:
1. SmartThings sends INSTALL lifecycle event to your webhook
2. Event contains installedAppId and locationId
3. Your server can automatically create subscriptions
4. Events will flow to your webhook

**Immediate Action Required**:
1. Add INSTALL lifecycle handler to webhook
2. Implement persistent storage for installedAppId
3. Document user installation process

**Workaround for Development**:
- Use existing `listInstalledApps()` to retrieve installedAppId after manual installation
- Store in environment variable or config file
- Use `SubscriptionService.subscribeToDefaults()` to create subscriptions
- Test event flow end-to-end

---

**Research Completed**: 2025-12-22
**File Location**: `docs/research/smartapp-installation-research-2025-12-22.md`
**Related Files**:
- `src/routes/webhook.ts` - Webhook handler (requires INSTALL case)
- `src/smartthings/subscription-service.ts` - Subscription management
- `src/server-alexa.ts` - Server initialization with installedApp lookup
- `docs/SMARTAPP_SETUP.md` - SmartApp OAuth setup guide

**Next Steps**:
1. Implement INSTALL lifecycle handler in webhook
2. Add file-based storage for installedAppId persistence
3. Update SMARTAPP_SETUP.md with installation instructions for users
4. Create script to manually create subscriptions (fallback method)
